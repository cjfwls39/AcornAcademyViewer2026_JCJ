/**
 * [diaryData] 최신 실습 데이터
 */
const diaryData = {
  20260122: [
    { title: "웹문서만들기", file: "index.html" },
    { title: "표 만들기", file: "table.html" },
    { title: "브라우저 종류", file: "브라우저종류.html" },
    { title: "시멘틱 태그", file: "시멘틱태그.html" },
    { title: "자기소개", file: "자기소개.html" },
    { title: "태그 연습", file: "태그연습.html" },
    { title: "하이퍼 링크", file: "하이퍼링크.html" },
  ],
  20260123: [
    { title: "a요소링크색상", file: "a요소링크색상.html" },
    { title: "breakpoint", file: "breakpoint_test.html" },
    { title: "css예제", file: "css예제.html" },
    { title: "css예제2", file: "css예제2.html" },
    { title: "Elvis", file: "Elvis.html" },
    { title: "오디오비디오", file: "오디오비디오.html" },
    { title: "점심메뉴", file: "점심메뉴.html" },
    { title: "텍스트꾸미기", file: "텍스트꾸미기.html" },
    { title: "페이지안의링크", file: "페이지안의링크.html" },
    { title: "폼관련태그", file: "폼관련태그.html" },
    { title: "폼태그예제", file: "폼태그예제.html", css: "style.css" },
    { title: "회원가입예제", file: "회원가입예제.html" },
  ],
  20260126: [
    { title: "background", file: "background.html" },
    { title: "backgroundScroll", file: "backgroundScroll.html" },
    { title: "backgroundScroll2", file: "backgroundScroll2.html" },
    { title: "border", file: "border.html" },
    { title: "box-sizing", file: "box-sizing.html" },
    { title: "float01", file: "float01.html" },
    { title: "float02", file: "float02.html" },
    { title: "float03", file: "float03.html" },
    { title: "gradient01", file: "gradient01.html" },
    { title: "grid", file: "grid.html" },
    { title: "grid예제", file: "grid예제.html" },
    { title: "readonly속성", file: "readonly속성.html" },
    { title: "shadow", file: "shadow.html" },
    { title: "네이버폼", file: "네이버폼.html", css: "naver_form.css" },
    { title: "박스모델활용", file: "박스모델활용.html" },
    { title: "블록요소로바꾸기", file: "블록요소로바꾸기.html" },
    { title: "호버메뉴예제", file: "호버메뉴예제.html" },
    { title: "호버버튼", file: "호버버튼.html" },
  ],
  20260127: [
    { title: "position_absolute", file: "position_absolute.html" },
    { title: "position_relative", file: "position_relative.html" },
    { title: "드롭다운", file: "드롭다운.html" },
    { title: "드롭다운2", file: "드롭다운2.html" },
    { title: "블루보틀", file: "블루보틀.html", css: "style.css" },
    { title: "플렉스박스", file: "플렉스박스.html" },
    { title: "플렉스박스과제", file: "플렉스박스과제.html" },
    { title: "플렉스박스과제2", file: "플렉스박스과제2.html" },
  ],
  20260128: [
    { title: "matrix", file: "matrix.html" },
    { title: "overflow", file: "overflow.html" },
    { title: "rotate", file: "rotate.html" },
    { title: "rotate3D", file: "rotate3D.html" },
    { title: "scale", file: "scale.html" },
    { title: "skew", file: "skew.html" },
    { title: "transition", file: "transition.html" },
    { title: "translate", file: "translate.html" },
    { title: "video", file: "video.html" },
    {
      title: "동영상응용사이트",
      file: "동영상응용사이트.html",
      css: "videoWebStyle.css",
    },
    { title: "드롭다운transition", file: "드롭다운transition.html" },
    { title: "상대폰트", file: "상대폰트.html" },
    { title: "신상품목록", file: "신상품목록.html" },
    { title: "창크기상대폰트", file: "창크기상대폰트.html" },
    { title: "툴팁효과", file: "툴팁효과.html" },
    {
      title: "한국금융주택공사페이지만들기",
      file: "한국금융주택공사페이지만들기.html",
      css: "style.css",
    },
  ],
  20260129: [
    { title: "animation01", file: "animation01.html" },
    { title: "animation02", file: "animation02.html" },
    { title: "animation03", file: "animation03.html" },
    {
      title: "hf미디어퓨리적용",
      file: "hf미디어퓨리적용.html",
      css: "style.css",
    },
    { title: "listStyle", file: "listStyle.html" },
    { title: "nth-of-type", file: "nth-of-type.html" },
    { title: "nth-of-type02", file: "nth-of-type02.html" },
    { title: "opacity_hover", file: "opacity_hover.html" },
    { title: "미디어퓨리", file: "미디어퓨리.html" },
    { title: "미디어퓨리2", file: "미디어퓨리2.html" },
    { title: "미디어퓨리3", file: "미디어퓨리3.html" },
    { title: "미디어퓨리메뉴바", file: "미디어퓨리메뉴바.html" },
    { title: "에니메이션예제", file: "에니메이션예제.html" },
    {
      folder: "pageLinkEX",
      children: [
        { title: "index", file: "index.html" },
        { title: "page", file: "page.html" },
        { title: "blog", file: "blog.html" },
        { title: "about", file: "about.html" },
        { title: "contact", file: "contact.html" },
      ],
    },
  ],
  20260130: [
    { title: "grid2", file: "grid2.html" },
    { title: "grid3", file: "grid3.html" },
    { title: "grid4", file: "grid4.html" },
    { title: "hf박스복습", file: "hf박스복습.html" },
    { title: "그리드area예제", file: "그리드area예제.html" },
    {
      folder: "MobileFirst",
      children: [
        {
          title: "index",
          file: "index.html",
          css: ["css/style.css", "css/reset.css"],
          js: "js/script.js",
        },
      ],
    },
    {
      folder: "스타벅스",
      children: [
        {
          title: "index",
          file: "index.html",
          css: "css/style.css",
          js: "js/main.js",
        },
      ],
    },
  ],

  20260202: [
    { title: "toggle", file: "toggle.html" },
    { title: "탭버튼css", file: "탭버튼css.html" },
    { title: "탭버튼css애니메이션", file: "탭버튼css애니메이션.html" },
    { title: "gradient02", file: "gradient02.html" },
    { title: "gradient03", file: "gradient03.html" },
    { title: "gradient04", file: "gradient04.html" },
    { title: "gradient05", file: "gradient05.html" },
    { title: "gradient06", file: "gradient06.html" },
    { title: "가변동영상", file: "가변동영상.html" },
    { title: "가상요소", file: "가상요소.html" },
    { title: "가상요소연습", file: "가상요소연습.html" },
  ],
};

// [글로벌 상태 관리 변수]
let editor = null;
let currentFile = null;
let currentBasePath = "";

// [Monaco Editor 초기 설정]
require.config({
  paths: {
    vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs",
  },
});
require(["vs/editor/editor.main"], function () {
  editor = monaco.editor.create(document.getElementById("editor-pane"), {
    value: "// 파일을 선택하면 코드가 여기에 나타납니다.",
    language: "html",
    theme: "vs-dark",
    automaticLayout: true,
    readOnly: true,
    fontSize: 14,
    minimap: { enabled: true },
  });
});

/**
 * 소스 코드를 서버에서 가져와 에디터에 출력하는 함수
 */
async function fetchCodeToEditor(path, language) {
  try {
    const response = await fetch(path);
    if (!response.ok) throw new Error("파일 로드 실패");
    const codeText = await response.text();

    const model = monaco.editor.createModel(codeText, language);
    editor.setModel(model);
  } catch (err) {
    editor.setValue(`// Error: ${err.message}\n// Path: ${path}`);
  }
}

/**
 * [탭 동적 생성 함수]
 */
function renderTabs(item, basePath) {
  const tabBar = document.getElementById("tab-bar");
  tabBar.innerHTML = "";

  const tabConfigs = [
    {
      label: "Preview",
      type: "preview",
      path: `${basePath}/${item.file}`,
    },
    { label: "HTML", type: "html", path: `${basePath}/${item.file}` },
  ];

  if (item.css) {
    const cssFiles = Array.isArray(item.css) ? item.css : [item.css];
    cssFiles.forEach((p) => {
      const fileName = p.split("/").pop();
      tabConfigs.push({
        label: fileName,
        type: "css",
        path: `${basePath}/${p}`,
      });
    });
  }

  if (item.js) {
    const jsFiles = Array.isArray(item.js) ? item.js : [item.js];
    jsFiles.forEach((p) => {
      const fileName = p.split("/").pop();
      tabConfigs.push({
        label: fileName,
        type: "javascript",
        path: `${basePath}/${p}`,
      });
    });
  }

  tabConfigs.forEach((cfg, idx) => {
    const tab = document.createElement("div");
    tab.className = "tab" + (idx === 0 ? " active" : "");
    tab.textContent = cfg.label;

    tab.onclick = () => {
      document
        .querySelectorAll(".tab")
        .forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");

      if (cfg.type === "preview") {
        document.getElementById("preview-pane").style.display = "block";
        document.getElementById("editor-pane").style.display = "none";
      } else {
        document.getElementById("preview-pane").style.display = "none";
        document.getElementById("editor-pane").style.display = "block";
        fetchCodeToEditor(cfg.path, cfg.type);
      }
    };
    tabBar.appendChild(tab);
  });
}

/**
 * [사이드바 트리 메뉴 생성 함수 (재귀)]
 */
const container = document.getElementById("file-list-container");
const iframe = document.getElementById("main-iframe");
const placeholder = document.getElementById("no-selection");

function renderTree(items, parent, currentPath) {
  items.forEach((item) => {
    if (item.folder) {
      const det = document.createElement("details");
      const sum = document.createElement("summary");
      sum.textContent = item.folder;
      det.appendChild(sum);
      renderTree(item.children, det, `${currentPath}/${item.folder}`);
      parent.appendChild(det);
    } else {
      const a = document.createElement("a");
      a.href = `${currentPath}/${item.file}`;
      a.target = "viewer";
      a.className = "file-link";
      a.textContent = item.title;

      a.onclick = function (e) {
        document
          .querySelectorAll(".file-link")
          .forEach((el) => el.classList.remove("active"));
        this.classList.add("active");

        currentFile = item;
        currentBasePath = currentPath;

        placeholder.style.display = "none";
        iframe.style.display = "block";

        renderTabs(item, currentPath);
      };
      parent.appendChild(a);
    }
  });
}

function init() {
  Object.keys(diaryData)
    .sort()
    // .reverse() // 최신 날짜가 위로 오게 변경
    .forEach((date) => {
      const det = document.createElement("details");
      const sum = document.createElement("summary");
      sum.textContent = `${date.substring(0, 4)}-${date.substring(4, 6)}-${date.substring(6, 8)}`;
      sum.style.fontWeight = "bold";
      sum.style.color = "#1e40af";
      det.appendChild(sum);
      renderTree(diaryData[date], det, date);
      container.appendChild(det);
    });
}

init();
